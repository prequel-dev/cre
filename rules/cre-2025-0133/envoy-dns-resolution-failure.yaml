rules:
  - metadata:
      kind: prequel
      id: EEP3qN5GANTvtrdGBJF7FN
      version: "0.1.0"
    cre:
      id: CRE-2025-0133
      severity: 1
      title: Envoy Upstream Cluster DNS Resolution Failures
      category: envoy-dns-resolution
      author: Prequel
      description: |
        - Envoy proxy experiences DNS resolution failures for upstream cluster endpoints, resulting in "no healthy upstream" errors.
        - DNS queries for upstream services return "Domain name not found" errors, causing service unavailability.
        - This leads to cascading failures where all requests to affected services receive HTTP 503 responses.
        - The issue persists until DNS configuration is corrected or upstream services become resolvable.
      cause: |
        - DNS server cannot resolve the configured upstream cluster domain names.
        - Misconfigured DNS records or nonexistent domain names in Envoy cluster configuration.
        - Network connectivity issues between Envoy and DNS servers.
        - DNS server failures or timeouts preventing successful resolution.
        - Invalid or expired DNS entries for upstream services.
      impact: |
        - Complete service unavailability for affected upstream clusters.
        - All client requests receive HTTP 503 Service Unavailable responses.
        - Degraded user experience and potential service outages.
        - Loss of traffic routing capability until DNS issues are resolved.
      tags:
         - dns-resolution
         - upstream-failure
         - service-unavailable
         - envoy-proxy
         - cluster-health
      mitigation: |
        - Verify DNS configuration and ensure upstream domain names are resolvable.
        - Implement health checks and monitoring for DNS resolution status.
        - Configure fallback DNS servers or alternative resolution methods.
        - Monitor Envoy cluster health and DNS resolution metrics.
        - Set up alerting for sustained "no healthy upstream" errors.
        - Use static IP addresses as backup when DNS is unreliable.
      references:
         - https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/cluster_manager
         - https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/health_checking
         - https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster
         - https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto
      reports: 1
      version: "0.1.0"
      applications:
        - name: "envoy"
          version: "1.28+"
    rule:
      set:
        window: 5m
        event:
             source: cre.log.envoy
        match:
          - regex: "(?i)(Domain name not found|dns resolution.*cares_norecords|no healthy upstream|DNS resolution failed)"
            count: 10
        negate:
          - "shutting down"
          - "graceful shutdown"