rules:
  - metadata:
      kind: prequel
      id: EEP3qN5GANTvtrdGBJF7FM
      version: "0.1.0"
    cre:
      id: CRE-2025-0130
      severity: 0
      title: Silent Write Loss During Replica Set Rollback
      category: mongodb-data-integrity
      author: Prequel
      description: |
        - In certain network partition and failover scenarios, MongoDB may silently discard acknowledged writes made to an old primary that becomes isolated and later performs a rollback.
        - No errors are thrown to clients — applications believe the writes succeeded, but they are permanently lost.
        - This is a critical data integrity issue that can affect financial transactions, orders, audit logs, etc.
      cause: |
       - A network partition causes the current primary to become isolated.
       - A new primary is elected among remaining nodes.
       - The isolated node, unaware of the re-election, continues accepting writes.
       - Upon reconnection, MongoDB rolls back the isolated node's data — silently discarding client-acknowledged writes.
      impact: |
        - Permanent, silent data loss without client awareness.
        - Undetectable unless rollback logs or oplog diffs are actively monitored.
        - Affects transactional integrity and trust in persisted state.
      tags:
         - silent-data-loss
         - rollback
         - replica-set
         - network-partition
         - election
      mitigation: |
        - Use majority write concern to reduce risk (e.g., `w: "majority"`).
        - Monitor rollback events and replica set elections.
        - Avoid deployments with unstable networking.
        - Alert on rollback metrics (`repl.rollback.total`) and `rs.status()` term mismatches.
      references:
         - https://www.mongodb.com/docs/manual/core/replica-set-rollbacks/ 
         - https://www.mongodb.com/docs/manual/reference/replica-states/ 
         - https://jira.mongodb.org/browse/SERVER-19605 
         - https://jira.mongodb.org/browse/SERVER-28005
         - https://jira.mongodb.org/browse/SERVER-27952 
         - https://jira.mongodb.org/browse/SERVER-50063 
         - https://jira.mongodb.org/browse/SERVER-63418
         - https://jira.mongodb.org/browse/SERVER-31641 
      reports: 3
      version: "0.1.0"
      applications:
        - name: "mongodb"
          version: "8.0"
    rule:
      set:
        window: 5m
        event:
             source: cre.log.mongo
        match:
          - regex: "(?i)Oplog fetcher stopped querying remote oplog with error"
          - regex: "(?i)New replica set config in use"
          - regex: "(?i)NetworkTimeout.*Socket operation timed out"
        negate:
          - "shutting down"